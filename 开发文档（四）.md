# 开发文档（四）

## 群聊模块

- 实现群组的创建、解散
- 实现用户申请加入群组
- 实现用户查看已加入的群组
- 实现群组成员退出已加入的群组
- 实现群组成员查看群组成员列表
- 实现群主对群组管理员的添加和删除
- 实现群组管理员批准用户加入群组
- 实现群组管理员/群主从群组中移除用户
- 实现群组内聊天功能

## 问题

1、是否应该根据权限不同而设置不同菜单，还是设置同样的菜单但是要获取相应权限才可以使用部分功能	

  先试着设置不同菜单

2、在服务器GroupService中是否需要onlineUsers

~~3、区分群组与用户id~~

4、群名称应该有限制后期加上

~~5、群id是由服务器还是客户端生成分配~~

​	~~答：服务器~~

6、改名

7、避免竞争问题

​	加锁

8、怎么存储管理员

9、对管理员的通知消息怎么处理，怎么做到共享处理结果

​	一个群组使用一个消息列表，管理员个人的消息队列拉取群组的通知

​	群通知格式

​		消息类型 type：“add“

​		来源 source：“account“

​		内容 data：“msg”// 对方留言

​		处理者：“ad_account”

~~10、一定要对空哈希表或者空数组初始化~~

​    ~~*// 对unordered_map进行初始化*~~

​    ~~unordered_map<string, string> emptyMap;~~

~~*// 对vector进行初始化*~~

​    ~~vector<string> emptyVector;~~

​    ~~userFriends = emptyVector;~~ 

11、客户端主子线程怎么实现通信

12、是否应该在groupmanager中再建类owner,member,admin

​		继承？

13、处理通知时，输入字母程序崩溃

14、不能加入自己已加入的群

15、进入群组有问题，只能进入自己加的群

16、显示群名

17、入群申请应该有限制，如覆盖前面发的申请

## 计划

### 1、~~实现群组的创建，~~解散

​	~~创建者即群主，只有群主有解散群的能力，群号随机分配，初始化设置群名，（以及管理员人数上限）考虑后期添加~~

​	~~创建时群组表应包括群名，群号，群主，其他的暂时没想到~~

​	群组要维护四张表，

​			第一张表（hash）包含群组信息

​			主键Group_id

​			群主 "owner" : account

​		    群人数：“number” :""(先不加)

​			在线人数：（以后加）

​		~~第二张表（list）包含群组通知~~

​			~~表名id_Group_Notice~~

​			~~群通知消息（主要是加群，提升为管理员，踢群）~~

​	      ~~一个群组使用一个消息列表，管理员个人的消息队列拉取群组的通知	消息应包含~~

​		~~主键：id"_Notice"~~

​		~~消息类型 type：“add“~~

​		~~来源 source：“account“~~

​		~~内容 msg：“msg”// 对方留言~~

​		~~处理者：“ad_account”~~

~~三、管理员集合~~

​	id+“_Administrator”

~~四、成员集合~~

 id+"_Member"

### 2、实现用户申请加入群组

​	~~输入群号发送申请，群主或管理员收到消息后决定是否通过，通过进入群菜单处理通知~~

​	不可重复申请进群

### 3、实现用户查看已加入的群组，即将用户群组表显示

​	依然是群名+群号+未读消息

​	用户在群组中的信息包括权限，还有什么暂时没想到，应该要用哈希存储

### 4、群组间聊天

​	进入显示最近的5条消息，可查看历史记录	，消息仍然使用列表存储，格式同好友聊天

表名groupid+"_Chat"

​	account ：“” time：“时间戳” data：“”

​	调用的时候再显示管理员与具体时间

### ~~5、菜单设置~~

​	~~在选择群组过后进入群组主菜单格式如下：~~

​	~~得到群组列表~~

​	~~功能选择：~~

~~#################################~~

​                        ~~1、添加群组~~

​						~~2、创建群组~~

​						~~3、进入群~~

​						~~4、查询群组~~

​						~~5、返回~~

~~##################################~~

~~选择4、进入群后~~

~~先输入群号~~

~~根据得到的权限显示菜单~~

~~普通成员：~~

~~###################################~~

​							~~1、聊天~~

​							~~2、查看群成员~~

​							~~3、查看历史记录~~

​							~~4、退出该群~~

​							~~5、返回~~

~~####################################~~

~~管理员：~~

~~#######################################~~

​							~~1、聊天~~

​							~~2、踢人~~

​							~~3、查看群成员~~

​							~~4、查看历史记录~~

​							~~5、群通知~~

​							~~6、退出该群~~

​							~~7、返回~~

~~######################################~~

~~踢人的时候只能踢普通成员~~

群主：

#######################################

​							1、聊天

​	显示权限，把聊天消息打进群消息队列中，实时通知先查询群友状态，如果在群聊中就直接发送过去显示消息，如果在线不再群聊中就发送一条通知，离线的不需要管，注意仍需要记录未读消息数

​							2、踢人

先查询是否在群聊中，然后再踢出，需要把成员账号从群成员表中踢出，如果是管理员则需要从管理员集合中删除

​							3、~~添加管理员~~

~~使用集合存储管理员账号（集合不会重复）~~

​							4、撤除管理员

从管理员集合转移到成员集合中

​							5、查看群成员

取出哈希表，将表中存储的账号进行遍历打印，要不要以集合的形式存储群成员？
管理员和群成员都用集合存储

​							6、查看历史记录

遍历取出消息 ，可以加个分页器

​							7、群通知

从群通知列表取出，选择以后填上处理人，如果已经处理过了则不能重复处理

通知类型：1、入群申请

​					2、提升管理员

​					3、踢人（还没写）

​					4、谁退出群聊（还没写）

​					（解散群聊直接通知个人，群相关的数据清除）

---------------------------------------------------------------------

​							8、修改群名

就直接redis一改

​							9、解散该群

所有成员收到解散消息，

​							10、返回

#######################################

可以踢所有人，添加管理员有上限

### 6、早晚得重构一下客户端主子线程模块

### ~~7、先写groupcreate再写groupadd~~

​		~~创建群时，服务器自增分配一个群id,初始值为100,~~

### 8、配置文件重新排版

### 9、加群实时通知，管理员或群主进入群组可进行处理

​		用户申请入群时，遍历管理员和群主，如果有在线的就发送实时通知

10、通知也应该设置一个未读通知数

​	通知获取可以先获取5条		

~~11、进入群聊后或者创建群聊后需要把未读消息序号记为0;~~

12、处理通知消息的输入需要检查

13、群聊聊天消息应该记录的是已读取的消息序列，未读消息数由该序列号与群聊最后一条消息序列做对比

使用llen取得消息队列的元素个数

14、使用redis存储在线用户集合
